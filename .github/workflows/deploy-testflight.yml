name: Deploy to TestFlight

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g. 2.5.1)'
        required: false
        default: ''
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'

jobs:
  deploy:
    name: Build and Deploy to TestFlight
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: Cache Swift Package Manager & Build
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            derived_data
          key: ${{ runner.os }}-xcode-${{ hashFiles('**/Package.resolved', 'CurtainCall.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-xcode-

      - name: Install Ruby dependencies
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Create Secrets.xcconfig
        run: |
          printf 'KOPIS_API_KEY = %s\nKOPIS_BASE_URL = http:/$()/www.kopis.or.kr/openApi/restful\n' "$KOPIS_API_KEY" > CurtainCall/Application/Secrets.xcconfig
        env:
          KOPIS_API_KEY: ${{ secrets.KOPIS_API_KEY }}

      - name: Save certificates to disk
        run: |
          echo "${{ secrets.APPLE_CERTIFICATE_P12 }}" | base64 --decode > certificate.p12
          echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 --decode > api_key.p8

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: bundle exec fastlane test

      - name: Deploy to TestFlight
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_PATH: ${{ github.workspace }}/api_key.p8
          GITHUB_REF_NAME: ${{ github.event.inputs.version || github.ref_name }}
          P12_PATH: ${{ github.workspace }}/certificate.p12
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          PROFILE_PATH: ${{ github.workspace }}/profile.mobileprovision
        run: |
          bundle exec fastlane beta

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/*.ipa
            build/*.dSYM.zip
          retention-days: 30

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ~/Library/Logs/gym/
            fastlane/report.xml
          retention-days: 7

      - name: Notify Success
        if: success()
        run: |
          echo "Successfully deployed to TestFlight!"
          echo "Version: ${{ github.ref_name }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "Deployment to TestFlight failed!"
          echo "Check the logs for more details."
