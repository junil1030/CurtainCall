name: Deploy to TestFlight

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g. 2.5.1)'
        required: false
        default: ''
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'

jobs:
  deploy:
    name: Build and Deploy to TestFlight
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
      FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve Xcode version
        id: xcode-version
        run: |
          XCODE_VERSION=$(xcodebuild -version | tr '\n' ' ' | sed 's/[[:space:]]\+/-/g')
          echo "value=${XCODE_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ steps.xcode-version.outputs.value }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ steps.xcode-version.outputs.value }}-

      - name: Install Ruby dependencies
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Save certificates to disk
        run: |
          echo "${{ secrets.APPLE_CERTIFICATE_P12 }}" | base64 --decode > certificate.p12
          echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
          echo "${{ secrets.PROVISIONING_PROFILE_WIDGET }}" | base64 --decode > profile_widget.mobileprovision

      - name: Verify KOPIS secrets injection
        env:
          KOPIS_API_KEY: ${{ secrets.KOPIS_API_KEY }}
          KOPIS_BASE_URL: https://www.kopis.or.kr/openApi/restful/
        run: bundle exec fastlane verify_secrets

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        env:
          KOPIS_API_KEY: ${{ secrets.KOPIS_API_KEY }}
          KOPIS_BASE_URL: https://www.kopis.or.kr/openApi/restful/
        run: bundle exec fastlane test

      - name: Deploy to TestFlight
        env:
          KOPIS_API_KEY: ${{ secrets.KOPIS_API_KEY }}
          KOPIS_BASE_URL: https://www.kopis.or.kr/openApi/restful/
          APPLE_ID: ${{ secrets.APPLE_ID }}
          ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          GITHUB_REF_NAME: ${{ github.event.inputs.version || github.ref_name }}
          P12_PATH: ${{ github.workspace }}/certificate.p12
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          PROFILE_PATH: ${{ github.workspace }}/profile.mobileprovision
          PROFILE_WIDGET_PATH: ${{ github.workspace }}/profile_widget.mobileprovision
        run: |
          bundle exec fastlane beta

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/*.ipa
            build/*.dSYM.zip
          retention-days: 30

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ~/Library/Logs/gym/
            fastlane/report.xml
            build/logs/
          retention-days: 7

      - name: Show xcodebuild log on failure
        if: failure()
        run: |
          echo "=== Last 200 lines of xcodebuild log ==="
          find ~/Library/Logs/gym -name "*.log" -exec tail -200 {} \; 2>/dev/null || true
          find build/logs -name "*.log" -exec tail -200 {} \; 2>/dev/null || true

      - name: Notify Success
        if: success()
        run: |
          echo "Successfully deployed to TestFlight!"
          echo "Version: ${{ github.ref_name }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "Deployment to TestFlight failed!"
          echo "Check the logs for more details."
